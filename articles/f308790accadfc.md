---
title: "ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¡¨ç¤ºã‚’ VRT ã§æ‰‹è»½ã«æ‹…ä¿ã™ã‚‹"
emoji: "â³"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["vrt", "storybook", "msw", "regsuit", "react"]
published: true
publication_name: "socialplus"
---

ã“ã‚“ã«ã¡ã¯ã€mashabow ã§ã™ã€‚[æ˜¨æ—¥](https://zenn.dev/socialplus/articles/c3b2e14b9087bc)ã‹ã‚‰å§‹ã¾ã£ãŸ [Social PLUS Tech Blog](https://zenn.dev/p/socialplus) ã®æŠ€è¡“è¨˜äº‹ 1 æœ¬ç›®ãªã®ã§ãƒ“ãƒ“ã£ã¦ã„ã¾ã™ ğŸ¤—

## UI ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹

ã•ã¦ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã£ã¦ã‚ã‚Šã¾ã™ã‚ˆã­ã€‚ä»¥ä¸‹ã¯ã‚½ãƒ¼ã‚·ãƒ£ãƒ« PLUS ã®ç”»é¢ã®ä¸€ä¾‹ã§ã™ãŒã€API ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«è¡¨ç¤ºã™ã‚‹ã€ã“ã†ã„ã†ã‚„ã¤ã§ã™ã€‚

![ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¡¨ç¤ºã®ä¾‹](https://storage.googleapis.com/zenn-user-upload/07cad4fa4565-20240124.png)

æœ€è¿‘ã¯[ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³](https://note.com/golferdayo/n/na8f69dc61f8e)ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ã‚‚å½“ãŸã‚Šå‰ã«ãªã£ã¦ã„ã¾ã™ã€‚ç´°ã‹ãªæ°—é£ã„ã§ã™ãŒã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã¯å¿«é©ãª UX ã®ãŸã‚ã«ã¯æ¬ ã‹ã›ã¾ã›ã‚“ã€‚

ã—ã‹ã—ã“ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã€æ™®æ®µã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ã‚‹æœ€ä¸­ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã® API ãƒ¢ãƒƒã‚¯ã‚’ä½¿ã£ãŸã‚Šé«˜é€Ÿãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒãŒã‚ã£ãŸã‚Šã™ã‚‹ã®ã§ã€ã¨ã‚‚ã™ã‚Œã°ã†ã£ã‹ã‚Šè¦‹éã”ã—ãŒã¡ãªéƒ¨åˆ†ã§ã™ã€‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¡¨ç¤ºãŒå£Šã‚Œã¦ã„ãŸã¨ãã«ã€ã¯ãŸã—ã¦æ°—ã¥ã‘ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ ãƒ–ãƒ©ã‚¦ã‚¶ã® DevTools ã§[ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°](https://developer.chrome.com/docs/devtools/network?hl=ja#throttle)ã‚’æœ‰åŠ¹ã«ã™ã‚Œã°ç¢ºèªã¯ã§ãã¾ã™ãŒã€ã„ã¡ã„ã¡æ°—ã«ã™ã‚‹ã®ã¯é¢å€’ã§ã™ã€‚ãã—ã¦ã€ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã‚’è§£é™¤ã—å¿˜ã‚Œã¦è‡ªåˆ†ã«ã‚¤ãƒ©ãƒƒã¨ã™ã‚‹ã®ã‚‚ã‚ã‚‹ã‚ã‚‹ã§ã™ï¼ˆã§ã™ã‚ˆã­ï¼Ÿï¼‰ã€‚

ã¨ã„ã†ã“ã¨ã§ã€ã“ã®è¨˜äº‹ã§ã¯ **ã€Œãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¡¨ç¤ºãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ã€ã‚’ã§ãã‚‹ã ã‘æ‰‹è»½ã«ç¢ºèªãƒ»æ‹…ä¿ã™ã‚‹** ä»•çµ„ã¿ã‚’ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å½¢å¼ã§ç´¹ä»‹ã—ã¾ã™ã€‚ãªãŠã€ã€Œãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¡¨ç¤ºã€ã ã¨ã¡ã‚‡ã£ã¨é•·ã„ã®ã§ã€ä»¥ä¸‹ã§ã¯å˜ã«ã€Œãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã€ã¨å‘¼ã¶ã“ã¨ã«ã—ã¾ã™ã€‚

## Storybook ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

ã¾ãšã¯ Storybook ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ç¢ºèªã§ãã‚‹ã¨ã†ã‚Œã—ã„ã§ã™ã‚ˆã­ï¼Ÿ ã€Œã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã£ã¦ã©ã‚“ãªãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã ã£ãŸã£ã‘ï¼Ÿã€ã¨æ€ã£ãŸã¨ãã«ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã® story ãŒã‚ã‚Œã°ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚‚ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã‚‚æ‰‹è»½ã«ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã§ã¯ã€ã©ã†æ›¸ã‘ã°ã„ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ ã‚‚ã¡ã‚ã‚“ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã« `isLoading` ã®ã‚ˆã†ãª prop ãŒã‚ã‚Œã°ç°¡å˜ã§ã™ã€‚

```tsx:Foo.stories.tsx
export const Loading: Story = {
  args: {
    isLoading: true,
  },
};
```

ãŒã€ã™ã¹ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãã‚“ãªéƒ½åˆã®ã„ã„è¨­è¨ˆã«ãªã£ã¦ã„ã‚‹ã‚ã‘ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä¸­ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é£›ã°ã™å ´åˆã‚‚æ™®é€šã«ã‚ã‚‹ã§ã—ã‚‡ã†ã€‚ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚ˆã†ãªã€ç²’åº¦ã®å¤§ãã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚ã‚Œã°ãªãŠã•ã‚‰ã§ã™ã€‚

ãã“ã§ã€[MSW](https://mswjs.io/) ã‚’ä½¿ã£ã¦ã€Œãƒ¬ã‚¹ãƒãƒ³ã‚¹å¾…ã¡ã€ã®çŠ¶æ…‹ã‚’å†ç¾ã™ã‚‹ã“ã¨ã‚’è€ƒãˆã¾ã™ã€‚MSW ã§ã¯ã€[`ctx.delay('infinite')`](https://v1.mswjs.io/docs/api/context/delay)ï¼ˆv1ï¼‰ã‚„ [`delay('infinite')`](https://mswjs.io/docs/api/delay/#delay-modes)ï¼ˆv2ï¼‰ã‚’ä½¿ã†ã¨ã€Œã„ã¤ã¾ã§ãŸã£ã¦ã‚‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ã“ãªã„[ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©](https://v1.mswjs.io/docs/basics/request-handler)ã€ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
import { rest } from "msw";

rest.get("/foo", (_req, res, ctx) => res(ctx.delay("infinite")));
```

:::message
æ˜¨å¹´ MSW v2 ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¾ã™ãŒã€[`msw-storybook-addon`](https://storybook.js.org/addons/msw-storybook-addon) ã®å®‰å®šç‰ˆãŒ[ã¾ã  v2 ã«å¯¾å¿œã—ã¦ã„ãªã„](https://github.com/mswjs/msw-storybook-addon/issues/121)ãŸã‚ã€ã“ã®è¨˜äº‹ã§ã¯ MSW v1 ã‚’å‰æã«èª¬æ˜ã‚’ã—ã¦ã„ã¾ã™ã€‚ã¨ã¯ã„ãˆã€v2 ã§ã‚‚åŒã˜ã“ã¨ãŒã§ãã‚‹ã¯ãšã§ã™ã€‚
:::

ã¾ãšã€MSW ã¨ [`msw-storybook-addon`](https://storybook.js.org/addons/msw-storybook-addon) ã‚’å°å…¥ã—ã¾ã™ã€‚å°å…¥æ‰‹é †ã«ã¤ã„ã¦ã¯ã“ã®è¨˜äº‹ã§ã¯å‰²æ„›ã—ã¾ã™ã®ã§ã€å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚æ¬¡ã«ã€ã„ã¤ã¾ã§çµŒã£ã¦ã‚‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ã“ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ä½œã‚Šã€ãã‚Œã‚’ä½¿ã£ãŸ `Loading` story ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```tsx:Foo.stories.tsx
import { rest } from "msw";

export const Loading: Story = {
  parameters: {
    msw: [
      rest.get(
        "https://example.com/foo", // Foo ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§å©ã„ã¦ã„ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        (_req, res, ctx) => res(ctx.delay("infinite")),
      ),
    ],
  },
};
```

ã“ã‚Œã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã® story ãŒã§ãã¾ã—ãŸ ğŸ‰

## ã‚‚ã†å°‘ã—æ¥½ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’æ›¸ã

ã§ã‚‚ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ˆã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ•°ã ã‘ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’æ›¸ãã®ã¯é¢å€’ã§ã™ã‚ˆã­ï¼Ÿ ã¾ãŸã€ä¾‹ãˆã°ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® `Loading` story ã‚’æ›¸ã“ã†ã¨ã—ãŸå ´åˆã€ã€Œå­ã‚„å­«ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã©ã“ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã„ã‚‹ã‹ã€ãªã‚“ã¦æ°—ã«ã—ãŸãã‚ã‚Šã¾ã›ã‚“ã€‚

ã¨ã„ã†ã‚ã‘ã§ã€æ¥½ã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã¾ã™ã€‚ç°¡å˜ã®ãŸã‚ã«ã€Œ`Loading` story ã§ã¯ã€ã©ã“ã«å¯¾ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚ã£ã¦ã‚‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ã“ãªã„ã€ã¨ã„ã†å‰æã‚’ç½®ãã“ã¨ã«ã—ã¾ã—ã‚‡ã†ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ã® URL æŒ‡å®šã«ã¯[æ­£è¦è¡¨ç¾ãŒä½¿ãˆã‚‹](https://v1.mswjs.io/docs/basics/request-matching#regexp)ã®ã§ã€é›‘ã« `/.*/` ã‚’æŒ‡å®šã—ã¾ã™ã€‚HTTP ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚ `GET` ãŒå¤šã„ã¨ã¯æ€ã„ã¾ã™ãŒã€ã“ã®éš›ãªã®ã§ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å¯¾è±¡ã«ã™ã‚‹ [`rest.all()`](https://v1.mswjs.io/docs/api/rest#custom-methods) ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚ã“ã‚Œã§ã€**ã©ã‚“ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ã‚‚æ°¸é ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã•ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©**ã§ã‚ã‚‹ `infiniteRequestHandler` ãŒã§ãã¾ã—ãŸã€‚

```ts:handlers.ts
import { rest } from "msw";

export const infiniteRequestHandler = rest.all(/.*/, (_req, res, ctx) =>
  res(ctx.delay("infinite"))
);
```

ã‚ã¨ã¯ `Loading` story ã«æŒ‡å®šã™ã‚‹ã ã‘ã§ã™ã€‚

```tsx:Foo.stories.tsx
import { infiniteRequestHandler } from "./handlers"

export const Loading: Story = {
  parameters: {
    msw: [infiniteRequestHandler],
  },
};
```

ä¸Šã®ã‚ˆã†ã« `infiniteRequestHandler` ã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ‡ã‚Šå‡ºã—ã¦ãŠã‘ã°ã€**ã„ã‚ã„ã‚ãª `*.stories.tsx` ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ä½¿ã„å›ã™ã“ã¨ãŒã§ãã¾ã™**ã€‚ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯å˜ç´”ã§ã™ãŒã€ã ã„ã¶æ¥½ã«ãªã‚Šã¾ã—ãŸ ğŸ‘

çŠ¶æ³ã«ã‚ˆã£ã¦ã¯ã€Œã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ `infiniteRequestHandler` ã‹ã‚‰é™¤å¤–ã—ãŸã„ã€ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ãã®ã‚ˆã†ãªå ´åˆã¯å€‹åˆ¥ã«ä¸Šæ›¸ãã—ã¦ã‚„ã‚Œã° OK ã§ã™ã€‚

```tsx:Foo.stories.tsx
export const PartiallyLoading: Story = {
  parameters: {
    msw: [
      infiniteRequestHandler,
      // å€‹åˆ¥ã«ä¸Šæ›¸ã
      rest.get(
        "https://example.com/foo",
        (_req, res, ctx) => res(ctx.json({ message: "Hi!" })),
      ),
    ],
  },
};
```

## ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ã‚’ VRT ã§æ‹…ä¿ã™ã‚‹

ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã® story ã‚’ç”¨æ„ã—ã¾ã—ãŸãŒã€ã“ã‚Œã ã‘ã§ã¯ã€Œé–‹ç™ºã®é€”ä¸­ã§ã„ã¤ã®ã¾ã«ã‹ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãŒå£Šã‚Œã¦ã„ãŸã€ã¨ã„ã†ã“ã¨ãŒèµ·ã“ã‚Šãˆã¾ã™ã€‚ãã“ã§ã€ã€Œãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ã€ã‚’æ‹…ä¿ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è€ƒãˆã¦ã„ãã¾ã™ã€‚ã“ã‚Œã«ã¤ã„ã¦ã‚‚**ã§ãã‚‹ã ã‘æ‰‹è»½ã«**ã‚„ã‚ŠãŸã„ã®ã§ã€ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆï¼ˆVRTï¼‰ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ã‚‡ã†ã€‚

:::message
ã“ã®è¨˜äº‹ã§ã¯ VRT ã®æ¦‚å¿µãã®ã‚‚ã®ã‚„ã€å„ãƒ„ãƒ¼ãƒ«ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•ã«ã¤ã„ã¦ã¯èª¬æ˜ã‚’å‰²æ„›ã—ã¾ã™ã€‚å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã©ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã€[ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã®ãŸã‚ã®ãƒ†ã‚¹ãƒˆå…¥é–€](https://amzn.to/3SdPbdW)ã€ã‚‚ãŠã™ã™ã‚ã§ã™ã€‚
:::

å®šç•ªã®æ§‹æˆã§ã™ãŒã€å…ˆã»ã©ç”¨æ„ã—ãŸ `Loading` story ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ [Storycap](https://github.com/reg-viz/storycap) ã§æ’®å½±ã—ã€[reg-suit](https://reg-viz.github.io/reg-suit/) ã‚’ä½¿ã£ã¦å‰ã®ã‚³ãƒŸãƒƒãƒˆã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¨æ¯”è¼ƒã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ã—ã‹ã—ã€ãã®ã¾ã¾ Storycap ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®æ’®å½±ãŒçµ‚ã‚ã‚‰ãšã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã—ã¾ã„ã¾ã™ã€‚ã¨ã„ã†ã®ã‚‚ã€Storycap ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã™ã¹ã¦å®Œäº†ã™ã‚‹ã¾ã§å¾…ã£ã¦ã‹ã‚‰ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ã™ã‚‹ã€ã¨ã„ã†åˆ¶å¾¡ãŒå…¥ã£ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚ã“ã®å¾…ã¡å‡¦ç†ã¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å®‰å®šã•ã›ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ãŒã€Fetch API ã«ã‚ˆã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚‚å¯¾è±¡ã«ãªã£ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€`infiniteRequestHandler` ã‚’ä½¿ã£ã¦ã„ã‚‹ story ã§ã¯ã€ã„ã¤ã¾ã§çµŒã£ã¦ã‚‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®æ’®å½±ãŒè¡Œã‚ã‚Œã¾ã›ã‚“ã€‚

ã“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã¯ã€**`waitAssets` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ `waitImages` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¸¡æ–¹ã¨ã‚‚ `false` ã«ã—ã¦ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¾…ã¡ã‚’ç„¡åŠ¹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚

```tsx:Foo.stories.tsx
import { infiniteRequestHandler } from "./handlers"

export const Loading: Story = {
  parameters: {
    msw: [infiniteRequestHandler],
    // Storycap ã®è¨­å®š
    screenshot: {
      waitAssets: false,
      waitImages: false,
    },
  },
};
```

ã“ã‚Œã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã›ãšã«ã€ç„¡äº‹ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼

:::details Storycap ã®å¾…ã¡å‡¦ç†ã®è©³ç´°
ã“ã®å¾…ã¡å‡¦ç†ã¯ã€`ResourceWatcher` ã‚¯ãƒ©ã‚¹ã®ä»¥ä¸‹ã®ç®‡æ‰€ã§è¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ resolve ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

https://github.com/reg-viz/storycap/blob/v4.2.0/packages/storycrawler/src/browser/resource-watcher.ts#L93-L107

https://github.com/reg-viz/storycap/blob/v4.2.0/packages/storycrawler/src/browser/resource-watcher.ts#L52-L67

`fetch` ãªã©ã«ã‚ˆã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆ`request.resourceType() === 'xmlhttprequest'`ï¼‰ã¯ã“ã®ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã«ãªã£ã¦ã„ã¾ã™ã€‚

`waitAssets` ã¨ `waitImages` ã®ä¸¡æ–¹ã‚’ `false` ã«ã™ã‚‹ã¨ã€ä»¥ä¸‹ã® `if` æ–‡ã«ã‚ˆã£ã¦ `ResourceWatcher` ã«ã‚ˆã‚‹å¾…ã¡å‡¦ç†ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚

https://github.com/reg-viz/storycap/blob/v4.2.0/packages/storycap/src/node/capturing-browser.ts#L314-L318

:::

## `waitAssets` ã¨ `waitImages` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•ã§è¨­å®šã™ã‚‹

ã•ã¦ã€æœ€å¾Œã«ã‚‚ã†ã¡ã‚‡ã£ã¨æ¥½ã‚’ã—ã¾ã—ã‚‡ã†ã€‚`infiniteRequestHandler` ã‚’ä½¿ã£ã¦ã„ã‚‹ story ã«æ¯å›æ¯å› `waitAssets` ã¨ `waitImages` ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã¯ã€ã¶ã£ã¡ã‚ƒã‘é¢å€’ã§ã™ã‚ˆã­ï¼Ÿ ã‚ãŸã—ã¯é¢å€’ã§ã™ã€‚æŒ‡å®šã‚’ãŸã³ãŸã³å¿˜ã‚Œã¾ã—ãŸã—ã€ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒæ›¸ã„ãŸ `Loading` story ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã¨ãã«ã‚‚è¦‹è½ã¨ã—ã¾ã™ã€‚ã¨ã„ã†ã“ã¨ã§ã€è‡ªå‹•ã§è¨­å®šã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

å…¨ story ã«å¯¾ã—ã¦ã€ã€Œ`infiniteRequestHandler` ã‚’ä½¿ã£ã¦ã„ãŸã‚‰ `waitAssets` ã¨ `waitImages` ã‚’ `false` ã«ã™ã‚‹ã€ãŒè‡ªå‹•ã§ã§ãã‚Œã° OK ãªã‚ã‘ã§ã™ã€‚[ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿](https://storybook.js.org/docs/writing-stories/decorators#global-decorators)ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚

```tsx:preview.tsx
import type { Preview } from "@storybook/react";

import { infiniteRequestHandler } from './handlers';

const preview: Preview = {
  decorators: [
    (storyFn, context) => {
      if (context.parameters.msw.includes(infiniteRequestHandler)) {
        context.parameters.screenshot.waitAssets = false;
        context.parameters.screenshot.waitImages = false;
      }
      return storyFn(context);
    },
    ...,
  ],
  ...,
};

export default preview;
```

ã“ã†ã™ã‚Œã°ã€`waitAssets` ã¨ `waitImages` ã®æŒ‡å®šãŒä¸è¦ã«ãªã‚Šã¾ã™ ğŸ‰

```tsx:Foo.stories.tsx
import { infiniteRequestHandler } from "./handlers"

export const Loading: Story = {
  parameters: {
    msw: [infiniteRequestHandler],
    // ã„ã¡ã„ã¡æŒ‡å®šã—ãªãã¦ã‚‚ã‚ˆããªã£ãŸ
    // screenshot: {
    //   waitAssets: false,
    //   waitImages: false,
    // },
  },
};
```

## ã¾ã¨ã‚

ã¨ã„ã†ã‚ã‘ã§ã€æœ€çµ‚çš„ã«ã¯ä»¥ä¸‹ã®æ•°è¡Œã ã‘ã§ `Loading` story ãŒæ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã‚ã‚“ã©ãã•ãŒã‚Šã‚„ãªã‚ãŸã—ã§ã‚‚ã€ã“ã‚Œãã‚‰ã„ã ã£ãŸã‚‰ã„ã‚ã„ã‚ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã« `Loading` story ã‚’ãƒ“ã‚·ãƒã‚·æ›¸ã„ã¦ã„ã‘ã¾ã™ã€‚

```tsx:Foo.stories.tsx
import { infiniteRequestHandler } from "./handlers"

export const Loading: Story = {
  parameters: {
    msw: [infiniteRequestHandler],
  },
};
```

å®Ÿéš›ã®æ¥­å‹™ã§ã‚‚ã“ã‚“ãªæ„Ÿã˜ã« `Loading` story ã‚’ç”¨æ„ã—ã¦ã€VRT ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

![Storybook ä¸Šã«ãŸãã•ã‚“ã‚ã‚‹ `Loading` story](https://storage.googleapis.com/zenn-user-upload/d239ce819ee7-20240124.png)

ã‚‚ã£ã¨ä¾¿åˆ©ãªæ–¹æ³•ãŒã‚ã‚‹ã‚ˆï¼ã¨ã„ã†æ–¹ãŒã„ã¾ã—ãŸã‚‰ã€ãœã²ã‚³ãƒ¡ãƒ³ãƒˆã§æ•™ãˆã¦ãã ã•ã„ã€‚ã§ã¯ã§ã¯ã€‚
